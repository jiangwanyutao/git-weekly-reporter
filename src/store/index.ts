import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import { Project, Report, AppSettings } from '@/types';

interface AppState {
  // Projects
  projects: Project[];
  addProject: (path: string) => void;
  updateProject: (id: string, data: Partial<Project>) => void;
  removeProject: (id: string) => void;

  // Settings
  settings: AppSettings;
  updateSettings: (settings: Partial<AppSettings>) => void;

  // Reports
  reports: Report[];
  addReport: (report: Report) => void;
  deleteReport: (id: string) => void;
}

const DEFAULT_PROMPT = `你是一个专业的周报助手。请根据我提供的 Git 提交记录，为我生成一份结构清晰、重点突出的周报。

**核心要求：**
1. **按项目严格分类**：提交记录中可能包含多个项目（以 \`[项目名]\` 标识）。请将“详细工作内容”部分按不同项目分开叙述，**不要**将所有内容混在一起。
2. **使用统一格式**：请严格按照以下提供的模板结构进行生成，确保格式统一、易于阅读。

**周报格式模板：**
---
**周报周期：** [自动计算起始日期] - [自动计算结束日期]

**详细工作内容：**

**【项目A名称】**
*   **功能/模块A1：** 描述相关提交完成的工作。
*   **功能/模块A2：** 描述相关提交完成的工作。
*   **优化与修复：** 描述相关的Bug修复、代码优化或重构工作。

**【项目B名称】**
*   **功能/模块B1：** 描述相关提交完成的工作。
*   **功能/模块B2：** 描述相关提交完成的工作。
*   **优化与修复：** 描述相关的Bug修复、代码优化或重构工作。

*(如果还有更多项目，请按相同格式添加)*
---

**请根据以下 Git 提交记录生成周报：**
{{commits}}`;

export const useAppStore = create<AppState>()(
  persist(
    (set, get) => ({
      projects: [],
      settings: {
        authorName: '',
        glmApiKey: '',
        promptTemplate: DEFAULT_PROMPT,
        autoGenerate: false,
        autoGenerateDay: 5, // Friday
        autoGenerateTime: '17:00',
      },
      reports: [],

      addProject: (path) => {
        const { projects } = get();
        if (projects.some((p) => p.path === path)) {
          throw new Error('项目已存在');
        }

        const name = path.split(/[\\/]/).pop() || 'Unknown';
        set((state) => ({
          projects: [
            ...state.projects,
            { id: crypto.randomUUID(), path, name, lastUpdated: Date.now() },
          ],
        }));
      },
      updateProject: (id: string, data: Partial<Project>) =>
        set((state) => ({
          projects: state.projects.map((p) =>
            p.id === id ? { ...p, ...data } : p
          ),
        })),
      removeProject: (id) =>
        set((state) => ({
          projects: state.projects.filter((p) => p.id !== id),
        })),

      updateSettings: (newSettings) =>
        set((state) => ({
          settings: { ...state.settings, ...newSettings },
        })),

      addReport: (report) =>
        set((state) => ({
          reports: [report, ...state.reports],
        })),
      deleteReport: (id) =>
        set((state) => ({
          reports: state.reports.filter((r) => r.id !== id),
        })),
    }),
    {
      name: 'git-weekly-reporter-storage',
    }
  )
);
